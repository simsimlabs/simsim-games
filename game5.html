<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íƒ±í¬ ë°°í‹€ - ì‹¬ì‹¬í’€ì´ ê²Œì„ ì—°êµ¬ì†Œ</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2261846676525942" crossorigin="anonymous"></script>
    
    <link rel="canonical" href="https://simsimlabs.com/simsim-games/game5.html">

    <meta name="description" content="íƒ±í¬ ë°°í‹€(Tank Battle.io) ë¬´ë£Œ ì›¹ê²Œì„. ë„í˜•ì„ ë¶€ìˆ˜ê³  ë ˆë²¨ì—…í•˜ì—¬ ì „ì¥ì„ ì§€ë°°í•˜ì„¸ìš”. ì„¤ì¹˜ ì—†ëŠ” ì‹¤ì‹œê°„ ìŠˆíŒ… ì•¡ì…˜ ê²Œì„.">
    
    <meta property="og:type" content="website">
    <meta property="og:title" content="ğŸ›¡ï¸ íƒ±í¬ ë°°í‹€ - ì‹¬ì‹¬í’€ì´ ê²Œì„ ì—°êµ¬ì†Œ">
    <meta property="og:description" content="ë„í˜•ì„ ë¶€ìˆ˜ê³  ë ˆë²¨ì—…! ìŠ¤íƒ¯ì„ ì°ì–´ ë‚˜ë§Œì˜ ê°•ë ¥í•œ íƒ±í¬ë¡œ ì „ì¥ì„ ì§€ë°°í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://simsimlabs.com/simsim-games/thumbnail.png">
    <meta property="og:url" content="https://simsimlabs.com/simsim-games/game5.html">

    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* 1. ë ˆì´ì•„ì›ƒ & ë°°ê²½ */
        body { 
            margin: 0; padding: 0; 
            background-color: #f0f2f5; 
            font-family: 'Noto Sans KR', sans-serif;
            color: #333;
            overflow-x: hidden; 
        }

        header {
            background: #2d3436; color: white; padding: 15px 20px; text-align: center;
        }

        .header-top {
            display: flex; justify-content: space-between; max-width: 1200px; margin: 0 auto 10px; font-size: 0.9rem;
        }
        .header-top a { color: #bdc3c7; text-decoration: none; }

        h1 { margin: 0; font-family: 'Jua', sans-serif; font-size: 1.8rem; }

        /* 2. ê´‘ê³  ì˜ì—­ */
        .ad-banner {
            width: 100%; max-width: 1200px; margin: 20px auto;
            text-align: center; background: #fff; padding: 10px 0;
            border-radius: 8px; overflow: hidden;
        }

        /* 3. ê²Œì„ ì»¨í…Œì´ë„ˆ (ë°˜ì‘í˜•) */
        #game-container-box {
            position: relative;
            width: 100%; 
            max-width: 1280px; 
            height: 720px;     
            margin: 0 auto;
            background-color: #b4b4b4; /* ì¸ê²Œì„ ë°°ê²½ìƒ‰ */
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }

        /* 4. UI ë ˆì´ì–´ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: white; text-align: center;
        }

        #ui-layer h2 { font-family: 'Jua', sans-serif; font-size: 3.5rem; color: #74b9ff; margin-bottom: 10px; text-shadow: 3px 3px 0 #fff; }
        #ui-layer p { font-size: 1.2rem; color: #dfe6e9; margin-bottom: 30px; line-height: 1.6; }
        
        #start-btn {
            background: #0984e3; color: white; border: none; padding: 15px 60px;
            font-size: 1.8rem; font-family: 'Jua', sans-serif; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 0 #0769b5; transition: transform 0.1s;
        }
        #start-btn:active { transform: translateY(4px); box-shadow: none; }
        #start-btn:hover { background: #74b9ff; }

        /* 5. HUD */
        #leaderboard {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.6); color: white; padding: 15px;
            border-radius: 8px; font-family: 'Jua', sans-serif; font-size: 1rem;
            min-width: 160px; pointer-events: none; z-index: 50;
        }
        #rank-list { list-style: none; padding: 0; margin: 0; }
        #rank-list li { margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.2); }

        #score-box {
            position: absolute; top: 15px; left: 15px;
            color: white; font-family: 'Jua', sans-serif; font-size: 1.5rem;
            text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 50;
        }

        #kill-log {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(45, 52, 54, 0.9); color: white;
            padding: 10px 30px; border-radius: 30px; font-weight: bold;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 50;
            white-space: nowrap; font-size: 1.1rem;
        }

        /* 6. ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ */
        #joystick-zone {
            position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px;
            z-index: 90; display: none; 
        }
        #joystick-bg {
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.15);
            border-radius: 50%; position: relative; border: 2px solid rgba(0,0,0,0.2);
        }
        #joystick-stick {
            width: 60px; height: 60px; background: rgba(0, 0, 0, 0.4);
            border-radius: 50%; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }

        /* 7. ì½˜í…ì¸  ì„¤ëª…ê¸€ */
        .content-article {
            max-width: 1200px; margin: 40px auto; padding: 40px;
            background: #fff; border-radius: 12px; line-height: 1.8;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .content-article h2 { color: #0984e3; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px; margin-top: 30px; }
        .content-article h3 { color: #ff7675; margin-top: 25px; }
        .content-article ul { background: #f8f9fa; padding: 20px 40px; border-radius: 8px; }

        /* 8. ê³µìœ  ë²„íŠ¼ */
        .share-bar { text-align: center; margin: 30px 0; }
        .share-btn {
            background: #333; color: white; border: none; padding: 12px 25px;
            border-radius: 30px; cursor: pointer; font-size: 1rem; margin: 0 5px;
            transition: 0.2s;
        }
        .share-btn:hover { transform: translateY(-2px); }
        .share-btn.copy { background: #6c5ce7; }
        
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px;
            background-color: #333; color: #fff; text-align: center;
            border-radius: 2px; padding: 16px; position: fixed; z-index: 1000;
            left: 50%; bottom: 30px; font-size: 17px; opacity: 0; transition: 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

        footer { text-align: center; padding: 30px; color: #b2bec3; font-size: 0.9rem; }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 800px) {
            #game-container-box {
                width: 100%;
                height: 85vh; 
                border-radius: 0;
            }
            #ui-layer h2 { font-size: 2.2rem; }
            .content-article { margin: 20px 10px; padding: 20px; }
            h1 { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <a href="en/game5.html">ğŸ‡ºğŸ‡¸ English</a>
            <a href="index.html">ğŸ  ê²Œì„ ëª©ë¡ìœ¼ë¡œ</a>
        </div>
        <h1>ğŸ›¡ï¸ íƒ±í¬ ë°°í‹€</h1>
    </header>

    <div class="ad-banner">
        <span style="font-size:10px; color:#ccc;">Sponsored</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2261846676525942"
             data-ad-slot="4380369066"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div id="game-container-box">
        <canvas id="gameCanvas"></canvas>

        <div id="score-box">ì ìˆ˜: 0</div>

        <div id="leaderboard">
            <h3>ğŸ† ë­í‚¹ Top 5</h3>
            <ul id="rank-list"><li>Loading...</li></ul>
        </div>

        <div id="kill-log"></div>

        <div id="joystick-zone">
            <div id="joystick-bg">
                <div id="joystick-stick"></div>
            </div>
        </div>

        <div id="ui-layer">
            <h2 id="ui-title">Tank Battle</h2>
            <p id="ui-desc">
                ë„í˜•ì„ ë¶€ìˆ˜ê³  ë ˆë²¨ì—…í•˜ì„¸ìš”!<br>
                [WASD] ì´ë™ / [ë§ˆìš°ìŠ¤] ì¡°ì¤€ & ë°œì‚¬
            </p>
            <button id="start-btn">ê²Œì„ ì‹œì‘ â–¶</button>
        </div>
    </div>

    <div class="ad-banner">
        <span style="font-size:10px; color:#ccc;">Sponsored</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-2261846676525942"
             data-ad-slot="4380369066"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div class="share-bar">
        <button class="share-btn copy" onclick="copyLink()"><i class="fa-solid fa-link"></i> ì¹œêµ¬ì™€ ë§í¬ ê³µìœ </button>
    </div>
    <div id="toast">ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!</div>

    <article class="content-article">
        <h2>ğŸ® íƒ±í¬ ë°°í‹€ (Diep.io ìŠ¤íƒ€ì¼) ê°€ì´ë“œ</h2>
        <p>
            ë‚˜ë§Œì˜ íƒ±í¬ë¥¼ ì¡°ì¢…í•˜ì—¬ ì „ì¥ì„ ëˆ„ë¹„ì„¸ìš”!
            ë§µì— í©ì–´ì§„ ë„í˜•(ë„¤ëª¨, ì„¸ëª¨, ì˜¤ê°í˜•)ì„ íŒŒê´´í•˜ì—¬ ê²½í—˜ì¹˜ë¥¼ ì–»ê³  ë ˆë²¨ì—…í•˜ì„¸ìš”.
            ë ˆë²¨ì´ ì˜¤ë¥´ë©´ ëŠ¥ë ¥ì¹˜ê°€ ìƒìŠ¹í•˜ê³  ë” ê°•ë ¥í•œ ì ë“¤ê³¼ ì‹¸ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <h3>ğŸ•¹ï¸ ì¡°ì‘ ë°©ë²•</h3>
        <ul>
            <li><strong>PC:</strong> WASD í‚¤ë¡œ ì´ë™, ë§ˆìš°ìŠ¤ë¡œ ì¡°ì¤€í•˜ê³  í´ë¦­í•˜ì—¬ ë°œì‚¬í•©ë‹ˆë‹¤.</li>
            <li><strong>ëª¨ë°”ì¼:</strong> ì¢Œì¸¡ ì¡°ì´ìŠ¤í‹±ìœ¼ë¡œ ì´ë™í•˜ê³ , í™”ë©´ ì˜¤ë¥¸ìª½ì„ í„°ì¹˜í•˜ì—¬ í•´ë‹¹ ë°©í–¥ìœ¼ë¡œ ë°œì‚¬í•©ë‹ˆë‹¤.</li>
            <li><strong>ì „ëµ:</strong> ë¬´ë¦¬í•˜ê²Œ ì ê³¼ ì‹¸ìš°ê¸°ë³´ë‹¤ ë„í˜•ì„ ë¶€ìˆ˜ë©° ì•ˆì „í•˜ê²Œ ì„±ì¥í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.</li>
        </ul>

        <h3>ğŸ† ìƒì¡´ íŒ</h3>
        <p>
            1. <strong>ë„í˜• íŒŒë°:</strong> ë…¸ë€ ë„¤ëª¨ < ë¹¨ê°„ ì„¸ëª¨ < íŒŒë€ ì˜¤ê°í˜• ìˆœìœ¼ë¡œ ê²½í—˜ì¹˜ë¥¼ ë§ì´ ì¤ë‹ˆë‹¤.<br><br>
            2. <strong>íšŒí”¼ ê¸°ë™:</strong> ì ì˜ ì´ì•Œì€ ëŠë¦¬ê²Œ ë‚ ì•„ì˜µë‹ˆë‹¤. ì˜ˆì¸¡ ì‚¬ê²©ì„ í”¼í•˜ë©° ë¬´ë¹™ìƒ·ì„ ì—°ìŠµí•˜ì„¸ìš”.<br><br>
            3. <strong>ìŠ¤íƒ¯ ê´€ë¦¬:</strong> ë ˆë²¨ì—… ì‹œ ë°ë¯¸ì§€ì™€ ì²´ë ¥ì´ ìë™ìœ¼ë¡œ ìƒìŠ¹í•©ë‹ˆë‹¤.
        </p>
    </article>

    <footer>
        <p>Â© 2024 SimSim Game Labs. All rights reserved.</p>
        <a href="https://simsimlabs.com/privacy.html" style="color:#b2bec3; text-decoration:none;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
    </footer>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('game-container-box');
        
        const uiLayer = document.getElementById('ui-layer');
        const uiTitle = document.getElementById('ui-title');
        const uiDesc = document.getElementById('ui-desc');
        const startBtn = document.getElementById('start-btn');
        const scoreBox = document.getElementById('score-box');
        
        const rankList = document.getElementById('rank-list');
        const killLog = document.getElementById('kill-log');
        const joystickZone = document.getElementById('joystick-zone');
        const joystickStick = document.getElementById('joystick-stick');

        // ê²Œì„ ì„¤ì •
        const MAP_SIZE = 3000;
        const SHAPE_COUNT = 300;
        const BOT_COUNT = 10;
        
        let entities = []; 
        let particles = [];
        let gameRunning = false;
        let animationFrameId;
        
        let player = null;
        let inputType = 'mouse';
        let mouseX = 0, mouseY = 0;
        let joystickVector = { x: 0, y: 0 };
        let isFiring = false;
        
        let keys = { w: false, a: false, s: false, d: false };
        let joystickActive = false;

        const adjectives = ["ê°•ì² ", "ë¹ ë¥¸", "ë¬´ê±°ìš´", "ì„±ë‚œ", "ìš©ê°í•œ", "ë¯¸ì¹œ", "ì¡°ìš©í•œ", "ì „ì„¤ì˜"];
        const nouns = ["íƒ±í¬", "ì „ì°¨", "ëŒ€í¬", "ìˆ˜í˜¸ì", "íŒŒê´´ì", "ì €ê²©ìˆ˜", "ì‚¬ë ¹ê´€", "íŒŒì¼ëŸ¿"];
        function getName() { return adjectives[Math.floor(Math.random()*adjectives.length)] + " " + nouns[Math.floor(Math.random()*nouns.length)]; }

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                joystickZone.style.display = 'block';
                inputType = 'joystick';
                initJoystick();
            }

            container.addEventListener('mousemove', e => {
                if(inputType !== 'joystick') {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    mouseX = (e.clientX - rect.left) * scaleX;
                    mouseY = (e.clientY - rect.top) * scaleY;
                }
            });
            container.addEventListener('mousedown', () => { isFiring = true; inputType='mouse'; });
            container.addEventListener('mouseup', () => { isFiring = false; });
            
            window.addEventListener('keydown', e => { 
                if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = true; 
            });
            window.addEventListener('keyup', e => { 
                if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; 
            });

            container.addEventListener('touchstart', e => {
                let touchX = e.touches[0].clientX;
                if(touchX > window.innerWidth / 2) isFiring = true;
            }, {passive:false});
            container.addEventListener('touchend', e => {
                if (e.touches.length === 0) isFiring = false;
            });

            startBtn.addEventListener('click', startGame);
        }

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        function initJoystick() {
            let startX, startY;
            const maxDist = 35;
            
            joystickZone.addEventListener('touchstart', e => {
                e.preventDefault();
                joystickActive = true;
                let t = e.touches[0];
                startX = t.clientX;
                startY = t.clientY;
                joystickStick.style.transition = 'none';
            });

            joystickZone.addEventListener('touchmove', e => {
                if(!joystickActive) return;
                e.preventDefault();
                let t = e.touches[0];
                let dx = t.clientX - startX;
                let dy = t.clientY - startY;
                let dist = Math.min(maxDist, Math.hypot(dx, dy));
                let angle = Math.atan2(dy, dx);
                
                joystickVector = { 
                    x: Math.cos(angle) * (dist/maxDist), 
                    y: Math.sin(angle) * (dist/maxDist) 
                };

                joystickStick.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
            });

            joystickZone.addEventListener('touchend', e => {
                e.preventDefault();
                joystickActive = false;
                joystickVector = { x: 0, y: 0 };
                joystickStick.style.transform = `translate(-50%, -50%)`;
            });
        }

        function startGame() {
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            uiLayer.style.display = 'none';
            gameRunning = true;
            
            // [ìˆ˜ì •] ë°°ì—´ ì´ˆê¸°í™” ìˆœì„œì™€ ë¡œì§ ëª…í™•íˆ
            entities = [];
            particles = [];
            isFiring = false;
            keys = { w: false, a: false, s: false, d: false };

            for(let i=0; i<SHAPE_COUNT; i++) spawnShape();
            
            // í”Œë ˆì´ì–´ ìƒì„± (ë°˜í™˜ê°’ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥)
            player = spawnTank(true);
            
            for(let i=0; i<BOT_COUNT; i++) spawnTank(false);

            loop();
        }

        function spawnTank(isHuman) {
            let tX, tY, safe;
            let attempts = 0;
            // ìŠ¤í° ìœ„ì¹˜ ì•ˆì „ ê²€ì‚¬ (ë‹¤ë¥¸ íƒ±í¬ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ)
            do {
                safe = true;
                tX = Math.random() * (MAP_SIZE - 200) + 100;
                tY = Math.random() * (MAP_SIZE - 200) + 100;
                for(let e of entities) {
                    if(e.type === 'tank' && Math.hypot(e.x - tX, e.y - tY) < 100) {
                        safe = false; break;
                    }
                }
                attempts++;
            } while(!safe && attempts < 50);

            let t = {
                type: 'tank',
                id: Math.random(),
                isHuman: isHuman,
                x: tX, y: tY,
                r: 20,
                color: isHuman ? '#00b894' : '#d63031',
                angle: 0, gunAngle: 0,
                hp: 100, maxHp: 100,
                score: 0, level: 1,
                name: isHuman ? 'ë‚˜ (Player)' : getName(),
                reload: 0, reloadTime: 30,
                damage: 10, speed: 3.5,
                aiTarget: null, aiTimer: 0,
                aiState: 'farm', // farm, combat
                remove: false
            };
            entities.push(t);
            return t;
        }

        function spawnShape() {
            let rand = Math.random();
            let shapeType = rand < 0.6 ? 0 : (rand < 0.9 ? 1 : 2); 
            
            let sX = Math.random() * MAP_SIZE;
            let sY = Math.random() * MAP_SIZE;

            let s = {
                type: 'shape',
                shapeType: shapeType,
                x: sX, y: sY,
                r: 15 + shapeType * 5,
                angle: Math.random() * Math.PI,
                rotationSpeed: (Math.random()-0.5) * 0.05,
                hp: 10 + shapeType * 20, maxHp: 10 + shapeType * 20,
                score: 10 + shapeType * 20,
                color: shapeType===0 ? '#ffeaa7' : (shapeType===1 ? '#ff7675' : '#74b9ff'),
                remove: false
            };
            entities.push(s);
        }

        function spawnBullet(owner) {
            owner.x -= Math.cos(owner.gunAngle) * 2; 
            owner.y -= Math.sin(owner.gunAngle) * 2;
            
            entities.push({
                type: 'bullet',
                ownerId: owner.id,
                x: owner.x + Math.cos(owner.gunAngle) * (owner.r + 5),
                y: owner.y + Math.sin(owner.gunAngle) * (owner.r + 5),
                vx: Math.cos(owner.gunAngle) * 12,
                vy: Math.sin(owner.gunAngle) * 12,
                r: 8, damage: owner.damage, life: 80, 
                color: owner.color,
                remove: false
            });
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8,
                    life: 20 + Math.random()*10,
                    color: color, r: Math.random()*4 + 2
                });
            }
        }

        function loop() {
            if(!gameRunning) return;
            
            ctx.setTransform(1, 0, 0, 1, 0, 0); 
            ctx.fillStyle = '#b4b4b4';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            let camX = MAP_SIZE/2, camY = MAP_SIZE/2;
            let zoom = 1;

            if (player && !player.remove) {
                camX = player.x; camY = player.y;
                zoom = Math.max(0.6, 25 / (player.r + 10)); 
            }

            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(zoom, zoom);
            ctx.translate(-camX, -camY);

            // ê²©ì ê·¸ë¦¬ê¸° (Culling ì ìš©)
            ctx.strokeStyle = '#a4a4a4'; ctx.lineWidth = 2; ctx.beginPath();
            let viewW = canvas.width / zoom;
            let viewH = canvas.height / zoom;
            let startX = Math.floor((camX - viewW/2) / 100) * 100;
            let endX = Math.ceil((camX + viewW/2) / 100) * 100;
            let startY = Math.floor((camY - viewH/2) / 100) * 100;
            let endY = Math.ceil((camY + viewH/2) / 100) * 100;

            for(let x=startX; x<=endX; x+=100) { 
                if(x>=0 && x<=MAP_SIZE) { ctx.moveTo(x, Math.max(0, startY)); ctx.lineTo(x, Math.min(MAP_SIZE, endY)); }
            }
            for(let y=startY; y<=endY; y+=100) { 
                if(y>=0 && y<=MAP_SIZE) { ctx.moveTo(Math.max(0, startX), y); ctx.lineTo(Math.min(MAP_SIZE, endX), y); }
            }
            ctx.stroke();
            
            ctx.strokeStyle = '#636e72'; ctx.lineWidth = 10; ctx.strokeRect(0,0,MAP_SIZE,MAP_SIZE);

            // ë¡œì§ ì—…ë°ì´íŠ¸
            for(let i=0; i<entities.length; i++) {
                let e = entities[i];
                if(e.remove) continue;

                if(e.type === 'tank') updateTank(e);
                else if(e.type === 'bullet') updateBullet(e);
                else if(e.type === 'shape') updateShape(e);
            }

            // ì¶©ëŒ ì²´í¬
            for(let i=0; i<entities.length; i++) {
                let b = entities[i];
                if(b.type !== 'bullet' || b.remove) continue;

                for(let j=0; j<entities.length; j++) {
                    let e = entities[j];
                    if(e === b || e.id === b.ownerId || e.type === 'bullet' || e.remove) continue;

                    let dist = Math.hypot(b.x - e.x, b.y - e.y);
                    if(dist < b.r + e.r) {
                        e.hp -= b.damage;
                        b.remove = true; 
                        createParticles(e.x, e.y, e.color, 3); 

                        if(e.hp <= 0) {
                            e.remove = true;
                            let owner = entities.find(ent => ent.id === b.ownerId);
                            if(owner && !owner.remove) {
                                owner.score += e.score || 100;
                                if(owner.score > owner.level * 150) {
                                    owner.level++; owner.damage += 3; owner.maxHp += 15; owner.hp = owner.maxHp; 
                                }
                            }
                            if(e.type === 'tank') killTank(e, owner ? owner.name : 'Unknown');
                            else createParticles(e.x, e.y, e.color, 8); 
                        }
                        break; 
                    }
                }
            }

            // ì‚­ì œëœ ê°ì²´ ì •ë¦¬
            entities = entities.filter(e => !e.remove);

            // ê·¸ë¦¬ê¸° (Culling)
            for(let e of entities) {
                if(Math.abs(e.x - camX) > (viewW/2 + 100) || Math.abs(e.y - camY) > (viewH/2 + 100)) {
                    if(e.type !== 'tank') continue; // íƒ±í¬ëŠ” ë°–ì—ì„œë„ ê·¸ë¦´ ìˆ˜ ìˆìŒ (ë¯¸ë‹ˆë§µ ë“± í™•ì¥ì„± ê³ ë ¤)
                }
                drawEntity(e);
            }

            // íŒŒí‹°í´
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life--;
                if(p.life <= 0) { particles.splice(i,1); continue; }
                if(Math.abs(p.x - camX) > viewW) continue; 
                
                ctx.globalAlpha = p.life / 30;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
            }

            // ë„í˜• ë¦¬í•„
            if(entities.filter(e=>e.type==='shape').length < 200) spawnShape();

            if(player && !player.remove) scoreBox.innerText = `ì ìˆ˜: ${player.score} (Lv.${player.level})`;
            
            updateLeaderboard();
            animationFrameId = requestAnimationFrame(loop);
        }

        function updateTank(t) {
            let moveX = 0, moveY = 0;
            
            if(t.isHuman) {
                if(inputType === 'mouse') {
                    let centerX = canvas.width / 2;
                    let centerY = canvas.height / 2;
                    t.gunAngle = Math.atan2(mouseY - centerY, mouseX - centerX);
                } else if(isFiring) {
                     if(joystickActive) t.gunAngle = Math.atan2(joystickVector.y, joystickVector.x);
                }

                if(keys.w) moveY = -1;
                if(keys.s) moveY = 1;
                if(keys.a) moveX = -1;
                if(keys.d) moveX = 1;

                if(joystickActive) { moveX = joystickVector.x; moveY = joystickVector.y; }

                if(isFiring && t.reload <= 0) {
                    spawnBullet(t);
                    t.reload = t.reloadTime;
                }
            } else {
                // [ìˆ˜ì •] ë´‡ AI: ë²½ í”¼í•˜ê¸° ì¶”ê°€
                t.aiTimer--;
                if(t.aiTimer <= 0) {
                    t.aiTimer = 20; 
                    let closest = null;
                    let minDist = 600; 
                    
                    // ë²½ ì²´í¬
                    if (t.x < 100 || t.x > MAP_SIZE - 100 || t.y < 100 || t.y > MAP_SIZE - 100) {
                        t.aiTarget = { x: MAP_SIZE/2, y: MAP_SIZE/2, remove: false }; // ì¤‘ì•™ìœ¼ë¡œ ê°€ë¼
                    } else {
                        // ì  ì°¾ê¸°
                        for(let other of entities) {
                            if(other.type === 'tank' && other !== t && !other.remove) {
                                let d = Math.hypot(t.x-other.x, t.y-other.y);
                                if(d < minDist) { minDist = d; closest = other; t.aiState = 'combat'; }
                            }
                        }
                        // ë„í˜• ì°¾ê¸°
                        if(!closest) {
                            t.aiState = 'farm';
                            for(let s of entities) {
                                if(s.type === 'shape' && !s.remove) {
                                    let d = Math.hypot(t.x-s.x, t.y-s.y);
                                    if(d < minDist) { minDist = d; closest = s; }
                                }
                            }
                        }
                        t.aiTarget = closest;
                    }
                }

                if(t.aiTarget && !t.aiTarget.remove) {
                    t.gunAngle = Math.atan2(t.aiTarget.y - t.y, t.aiTarget.x - t.x);
                    // [ìˆ˜ì •] íƒ„ í¼ì§ (ì •í™•ë„ í•˜í–¥)
                    if (t.aiState === 'combat') t.gunAngle += (Math.random() - 0.5) * 0.2;

                    moveX = Math.cos(t.gunAngle);
                    moveY = Math.sin(t.gunAngle);
                    
                    let dist = Math.hypot(t.aiTarget.x - t.x, t.aiTarget.y - t.y);
                    if(dist < 200 && t.aiState === 'combat') { moveX *= -1; moveY *= -1; }
                    else if(dist < 150) { moveX = 0; moveY = 0; }

                    if(dist < 500 && t.reload <= 0) {
                        spawnBullet(t);
                        t.reload = t.reloadTime;
                    }
                } else {
                    t.gunAngle += 0.05;
                    moveX = Math.cos(t.gunAngle) * 0.5; moveY = Math.sin(t.gunAngle) * 0.5;
                }
            }

            if(moveX !== 0 || moveY !== 0) {
                let len = Math.hypot(moveX, moveY);
                if(len > 1) len = 1;
                if(t.isHuman && !joystickActive && len > 0) { moveX /= len; moveY /= len; }
                
                let targetBodyAngle = Math.atan2(moveY, moveX);
                let diff = targetBodyAngle - t.angle;
                while (diff <= -Math.PI) diff += Math.PI*2;
                while (diff > Math.PI) diff -= Math.PI*2;
                t.angle += diff * 0.1;

                t.x += moveX * t.speed;
                t.y += moveY * t.speed;
                t.x = Math.max(0, Math.min(MAP_SIZE, t.x));
                t.y = Math.max(0, Math.min(MAP_SIZE, t.y));
            }
            t.reload--;
        }

        function updateBullet(b) {
            b.x += b.vx;
            b.y += b.vy;
            b.life--;
            if(b.life <= 0 || b.x<0 || b.x>MAP_SIZE || b.y<0 || b.y>MAP_SIZE) b.remove = true;
        }

        function updateShape(s) {
            s.angle += s.rotationSpeed;
        }

        function drawEntity(e) {
            ctx.save();
            ctx.translate(e.x, e.y);

            if(e.type === 'tank') {
                ctx.save();
                ctx.rotate(e.gunAngle);
                ctx.fillStyle = '#999'; ctx.fillRect(0, -e.r/2, e.r*2.2, e.r); 
                ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.strokeRect(0, -e.r/2, e.r*2.2, e.r);
                ctx.restore();

                ctx.rotate(e.angle);
                ctx.beginPath(); ctx.arc(0, 0, e.r, 0, Math.PI*2);
                ctx.fillStyle = e.color; ctx.fill(); ctx.stroke();
                
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(-e.r, -e.r, e.r*2, 6);
                ctx.fillRect(-e.r, e.r-6, e.r*2, 6);

                ctx.rotate(-e.angle);
                ctx.fillStyle = 'black'; ctx.fillRect(-20, e.r + 10, 40, 6);
                ctx.fillStyle = '#00b894'; ctx.fillRect(-19, e.r + 11, 38 * (e.hp/e.maxHp), 4);
                
                ctx.fillStyle = '#333'; ctx.font = 'bold 12px Noto Sans KR';
                ctx.textAlign = 'center'; ctx.fillText(`${e.name} [Lv.${e.level}]`, 0, -e.r - 10);

            } else if(e.type === 'bullet') {
                ctx.rotate(Math.atan2(e.vy, e.vx));
                ctx.beginPath(); ctx.arc(0, 0, e.r, 0, Math.PI*2);
                ctx.fillStyle = e.color; ctx.fill(); ctx.stroke();

            } else if(e.type === 'shape') {
                ctx.rotate(e.angle);
                ctx.fillStyle = e.color; ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
                
                let sides = e.shapeType === 0 ? 4 : (e.shapeType === 1 ? 3 : 5);
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    ctx.lineTo(e.r * Math.cos(i * 2 * Math.PI / sides), e.r * Math.sin(i * 2 * Math.PI / sides));
                }
                ctx.closePath(); ctx.fill(); ctx.stroke();
                
                if(e.hp < e.maxHp) {
                    ctx.rotate(-e.angle);
                    ctx.fillStyle = 'black'; ctx.fillRect(-10, 5, 20, 4);
                    ctx.fillStyle = '#00b894'; ctx.fillRect(-9, 6, 18 * (e.hp/e.maxHp), 2);
                }
            }
            ctx.restore();
        }

        function killTank(t, killerName) {
            createParticles(t.x, t.y, t.color, 15);
            if(t.isHuman) gameOver(killerName);
            else {
                showKillLog(`${killerName}ë‹˜ì´ ${t.name}ì„ ì²˜ì¹˜!`);
                setTimeout(() => { if(gameRunning) spawnTank(false); }, 3000);
            }
        }

        function showKillLog(msg) {
            killLog.innerText = msg; killLog.style.opacity = 1;
            setTimeout(() => { killLog.style.opacity = 0; }, 2000);
        }

        function updateLeaderboard() {
            let list = entities.filter(e => e.type === 'tank' && !e.remove).sort((a,b) => b.score - a.score);
            let html = '';
            for(let i=0; i<Math.min(5, list.length); i++) {
                let t = list[i];
                let name = t.isHuman ? `<span style="color:#0984e3">${t.name}</span>` : t.name;
                html += `<li>${i+1}. ${name} <small>(${t.score})</small></li>`;
            }
            rankList.innerHTML = html;
        }

        function gameOver(killer) {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId);
            ingameAd.style.display = 'none';
            ui.style.display = 'block';
            const btn = document.getElementById('start-btn');
            btn.innerText = "ë³µìˆ˜í•˜ëŸ¬ ê°€ê¸°! (ì¬ì‹œì‘)";
            ui.querySelector('h1').innerText = "ğŸ’€ ê²©íŒŒë¨";
            ui.querySelector('p').innerHTML = `<b>${killer}</b>ì—ê²Œ ë‹¹í–ˆìŠµë‹ˆë‹¤...<br>ìµœì¢… ì ìˆ˜: <span style="color:#0984e3;">${player.score}</span>`;
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const toast = document.getElementById("toast");
                toast.className = "show";
                setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
            });
        }

        init();
    </script>
</body>
</html>

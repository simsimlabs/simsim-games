<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íƒ±í¬ ë°°í‹€ - ì‹¬ì‹¬í’€ì´ ê²Œì„ ì—°êµ¬ì†Œ</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2261846676525942" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap');
 
        body { 
            margin: 0; padding: 0; overflow: hidden; background-color: #b4b4b4; 
            font-family: 'Noto Sans KR', sans-serif; user-select: none; touch-action: none;
        }

        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .game-overlay { pointer-events: none; position: fixed; z-index: 100; }

        #game-ui { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; background: rgba(255, 255, 255, 0.98);
            padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center; width: 90%; max-width: 420px; border: 5px solid #6c5ce7;
            pointer-events: auto;
        }

        #game-ui h1 { font-family: 'Jua', sans-serif; font-size: 3rem; color: #2d3436; margin: 0 0 10px 0; text-shadow: 2px 2px 0px #bdc3c7; }
        #game-ui p { color: #636e72; font-size: 1.1rem; margin-bottom: 20px; }

        #start-btn {
            background: #0984e3; color: white; border: none; padding: 15px 0;
            font-size: 1.8rem; font-family: 'Jua', sans-serif; border-radius: 50px;
            cursor: pointer; box-shadow: 0 6px 0 #0769b5; width: 100%; margin-bottom: 15px; transition: transform 0.1s; display: block;
        }
        #start-btn:active { transform: translateY(4px); box-shadow: none; }

        .back-link { display: inline-block; margin-top: 10px; color: #636e72; text-decoration: none; cursor: pointer; }
        .back-link:hover { color: #2d3436; text-decoration: underline; }

        #leaderboard { top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; padding: 15px; border-radius: 10px; font-family: 'Jua', sans-serif; min-width: 160px; }
        #rank-list { list-style: none; padding: 0; margin: 0; font-size: 0.95rem; }
        #rank-list li { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.2); }

        #kill-log { bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(45, 52, 54, 0.9); color: white; padding: 10px 25px; border-radius: 30px; font-weight: bold; opacity: 0; transition: opacity 0.3s; }

        #ingame-ad { position: fixed; bottom: 10px; right: 10px; z-index: 50; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); pointer-events: auto; display: none; }
        .ad-label { font-size: 10px; color: #ccc; text-align: right; display: block; }

        #joystick-zone { position: fixed; bottom: 30px; left: 30px; width: 120px; height: 120px; z-index: 200; display: none; pointer-events: auto; }
        #joystick-bg { width: 100%; height: 100%; background: rgba(0, 0, 0, 0.1); border-radius: 50%; position: relative; border: 2px solid rgba(0,0,0,0.2); }
        #joystick-stick { width: 50px; height: 50px; background: rgba(0, 0, 0, 0.3); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        @media (max-width: 600px) {
            #game-ui { width: 85%; }
            #ingame-ad { transform: scale(0.8); transform-origin: bottom right; bottom: 5px; right: 5px; }
            #joystick-zone { display: block; }
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="leaderboard" class="game-overlay">
        <h3>ğŸ† ì ìˆ˜ ë­í‚¹</h3>
        <ul id="rank-list"><li>ë¡œë”© ì¤‘...</li></ul>
    </div>

    <div id="kill-log" class="game-overlay"></div>

    <div id="joystick-zone">
        <div id="joystick-bg"><div id="joystick-stick"></div></div>
    </div>

    <div id="ingame-ad">
        <span class="ad-label">Sponsored</span>
        <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-2261846676525942" data-ad-slot="4380369066"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <div id="game-ui">
        <h1>ğŸ›¡ï¸ íƒ±í¬ ë°°í‹€</h1>
        <p>
            <b>[PC]</b> ì´ë™: WASD / ì¡°ì¤€: ë§ˆìš°ìŠ¤ / ë°œì‚¬: í´ë¦­<br>
            <b>[ëª¨ë°”ì¼]</b> ì´ë™: ì™¼ìª½ ì¡°ì´ìŠ¤í‹± / ë°œì‚¬: ì˜¤ë¥¸ìª½ í„°ì¹˜
        </p>
        <div style="margin: 15px 0; min-height: 100px; overflow:hidden;">
             <ins class="adsbygoogle" style="display:block; height: 100px;" data-ad-client="ca-pub-2261846676525942" data-ad-slot="4380369066" data-ad-format="horizontal" data-full-width-responsive="true"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
        <button id="start-btn">ê²Œì„ ì‹œì‘ â–¶</button>
        <br>
        <a href="index.html" class="back-link">ğŸ  ë©”ì¸ìœ¼ë¡œ ë‚˜ê°€ê¸°</a>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ui = document.getElementById('game-ui');
        const rankList = document.getElementById('rank-list');
        const killLog = document.getElementById('kill-log');
        const ingameAd = document.getElementById('ingame-ad');
        const startBtn = document.getElementById('start-btn');
        const joystickZone = document.getElementById('joystick-zone');
        const joystickStick = document.getElementById('joystick-stick');

        const MAP_SIZE = 4000;
        
        let entities = [];
        let particles = [];
        let gameRunning = false;
        let animationFrameId;
        
        let player = null;
        let inputType = 'mouse';
        let mouseX = 0, mouseY = 0;
        let joystickVector = { x: 0, y: 0 };
        let isFiring = false;
        
        let keys = {
            w: false, a: false, s: false, d: false,
            ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false
        };
        let joystickActive = false;

        const adjectives = ["ê°•ì² ", "ë¹ ë¥¸", "ë¬´ê±°ìš´", "ì„±ë‚œ", "ìš©ê°í•œ", "ë¯¸ì¹œ", "ì¡°ìš©í•œ", "ì „ì„¤ì˜"];
        const nouns = ["íƒ±í¬", "ì „ì°¨", "ëŒ€í¬", "ìˆ˜í˜¸ì", "íŒŒê´´ì", "ì €ê²©ìˆ˜", "ì‚¬ë ¹ê´€", "íŒŒì¼ëŸ¿"];
        function getName() { return adjectives[Math.floor(Math.random()*adjectives.length)] + " " + nouns[Math.floor(Math.random()*nouns.length)]; }

        document.addEventListener('DOMContentLoaded', () => {
            resize();
            window.addEventListener('resize', resize);
            if(startBtn) startBtn.addEventListener('click', startGame);
            initJoystick();
            
            window.addEventListener('mousemove', e => { 
                if(inputType!=='joystick') { mouseX=e.clientX; mouseY=e.clientY; } 
            });
            window.addEventListener('mousedown', () => { isFiring = true; inputType='mouse'; });
            window.addEventListener('mouseup', () => { isFiring = false; });
            
            window.addEventListener('keydown', e => { keys[e.key] = true; });
            window.addEventListener('keyup', e => { keys[e.key] = false; });
            
            window.addEventListener('touchstart', e => {
                if(e.touches[0].clientX > window.innerWidth/2) isFiring = true;
            }, {passive:false});
            window.addEventListener('touchend', e => {
                 if (e.touches.length === 0) isFiring = false;
            });
        });

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function startGame() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            gameRunning = true;
            entities = [];
            particles = [];
            
            isFiring = false;
            joystickVector = {x:0, y:0};

            for(let i=0; i<300; i++) spawnShape();
            player = spawnTank(true);
            for(let i=0; i<15; i++) spawnTank(false);

            ui.style.display = 'none';
            ingameAd.style.display = 'block';
            loop();
        }

        function spawnTank(isHuman) {
            let t = {
                type: 'tank',
                id: Math.random(),
                isHuman: isHuman,
                x: Math.random() * MAP_SIZE,
                y: Math.random() * MAP_SIZE,
                r: 20,
                color: isHuman ? '#00b894' : '#d63031',
                angle: 0, // ëª¸ì²´ ë°©í–¥
                gunAngle: 0, // í¬ì‹  ë°©í–¥
                hp: 100, maxHp: 100,
                score: 0, level: 1,
                name: isHuman ? 'ë‚˜ (Player)' : getName(),
                reload: 0, reloadTime: 30,
                damage: 10, speed: 2.8,
                aiTarget: null, aiTimer: 0, aiState: 'idle'
            };
            entities.push(t);
            return t;
        }

        function spawnShape() {
            let rand = Math.random();
            let shapeType = 0; 
            if(rand < 0.6) shapeType = 0;
            else if(rand < 0.9) shapeType = 1;
            else shapeType = 2;

            let s = {
                type: 'shape',
                shapeType: shapeType,
                x: Math.random() * MAP_SIZE,
                y: Math.random() * MAP_SIZE,
                r: 15 + shapeType * 5,
                angle: Math.random() * Math.PI,
                rotationSpeed: (Math.random()-0.5) * 0.05,
                hp: 10 + shapeType * 20,
                maxHp: 10 + shapeType * 20,
                score: 10 + shapeType * 20,
                color: shapeType===0 ? '#ffeaa7' : (shapeType===1 ? '#ff7675' : '#74b9ff')
            };
            entities.push(s);
        }

        function spawnBullet(owner) {
            // ë°˜ë™ (í¬ì‹  ë°©í–¥ìœ¼ë¡œ)
            owner.x -= Math.cos(owner.gunAngle) * 2;
            owner.y -= Math.sin(owner.gunAngle) * 2;

            entities.push({
                type: 'bullet',
                ownerId: owner.id,
                x: owner.x + Math.cos(owner.gunAngle) * (owner.r + 5),
                y: owner.y + Math.sin(owner.gunAngle) * (owner.r + 5),
                vx: Math.cos(owner.gunAngle) * 12,
                vy: Math.sin(owner.gunAngle) * 12,
                r: 8,
                damage: owner.damage,
                life: 100,
                color: owner.color
            });
        }

        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*5,
                    vy: (Math.random()-0.5)*5,
                    life: 20 + Math.random()*20,
                    color: color,
                    r: Math.random()*3 + 1
                });
            }
        }

        function initJoystick() {
            let startX, startY;
            const zone = joystickZone; const stick = joystickStick;
            const maxDist = 35;

            zone.addEventListener('touchstart', e => {
                e.preventDefault(); joystickActive = true;
                let t = e.touches[0]; startX = t.clientX; startY = t.clientY;
                stick.style.transition = 'none';
            }, {passive:false});

            zone.addEventListener('touchmove', e => {
                if(!joystickActive) return;
                e.preventDefault();
                let t = e.touches[0];
                let dx = t.clientX - startX; let dy = t.clientY - startY;
                let dist = Math.min(maxDist, Math.sqrt(dx*dx + dy*dy));
                let angle = Math.atan2(dy, dx);
                stick.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                
                joystickVector = { 
                    x: Math.cos(angle) * (dist/maxDist), 
                    y: Math.sin(angle) * (dist/maxDist) 
                };
            }, {passive:false});

            zone.addEventListener('touchend', e => {
                e.preventDefault(); joystickActive = false;
                stick.style.transform = `translate(-50%, -50%)`;
                joystickVector = {x:0, y:0};
            });
        }

        function loop() {
            if(!gameRunning) return;

            // 1. í™”ë©´ ì•ˆì „ ì´ˆê¸°í™”
            ctx.setTransform(1, 0, 0, 1, 0, 0); 
            ctx.fillStyle = '#b4b4b4';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. í”Œë ˆì´ì–´ ìƒíƒœ ì²´í¬ ë° ì¹´ë©”ë¼ ê³„ì‚°
            let camX = MAP_SIZE/2, camY = MAP_SIZE/2;
            let zoom = 1;

            if (player && !isNaN(player.x) && !isNaN(player.y)) {
                if(player.hp > 0) {
                    camX = player.x;
                    camY = player.y;
                    zoom = Math.max(0.6, 25 / (player.r + 10));
                }
            } else {
                // í”Œë ˆì´ì–´ê°€ ìœ ë ¹ì´ ë˜ë©´ ì¬ìƒì„±
                player = spawnTank(true);
            }

            // ì¹´ë©”ë¼ ì ìš©
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(zoom, zoom);
            ctx.translate(-camX, -camY);

            // 3. ê²©ì ê·¸ë¦¬ê¸° (í™”ë©´ ì˜ì—­ë§Œ)
            ctx.strokeStyle = '#a4a4a4'; ctx.lineWidth = 2; ctx.beginPath();
            
            let viewW = canvas.width / zoom;
            let viewH = canvas.height / zoom;
            let startX = Math.floor((camX - viewW/2) / 100) * 100;
            let endX = Math.ceil((camX + viewW/2) / 100) * 100;
            let startY = Math.floor((camY - viewH/2) / 100) * 100;
            let endY = Math.ceil((camY + viewH/2) / 100) * 100;

            for(let x=startX; x<=endX; x+=100) { 
                if(x>=0 && x<=MAP_SIZE) { ctx.moveTo(x, Math.max(0, startY)); ctx.lineTo(x, Math.min(MAP_SIZE, endY)); }
            }
            for(let y=startY; y<=endY; y+=100) { 
                if(y>=0 && y<=MAP_SIZE) { ctx.moveTo(Math.max(0, startX), y); ctx.lineTo(Math.min(MAP_SIZE, endX), y); }
            }
            ctx.stroke();
            
            ctx.strokeStyle = '#636e72'; ctx.lineWidth = 10; ctx.strokeRect(0,0,MAP_SIZE,MAP_SIZE);

            // 4. ì—”í‹°í‹° ì—…ë°ì´íŠ¸ ë° ê·¸ë¦¬ê¸°
            for(let i=entities.length-1; i>=0; i--) {
                let e = entities[i];
                
                // ê°„ë‹¨í•œ ì»¬ë§ (ë„ˆë¬´ ë¨¼ ê°ì²´ëŠ” ë¡œì§ë§Œ ëŒë¦¬ê³  ì•ˆ ê·¸ë¦¬ê¸°)
                let distToCam = Math.abs(e.x - camX) + Math.abs(e.y - camY);
                let isVisible = distToCam < (viewW + 200);

                if(e.type === 'tank') updateTank(e);
                else if(e.type === 'bullet') updateBullet(e, i);
                else if(e.type === 'shape') updateShape(e);

                if(isVisible) drawEntity(e);
            }

            // 5. íŒŒí‹°í´
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life--;
                if(p.life <= 0) { particles.splice(i,1); continue; }
                
                // íŒŒí‹°í´ ì»¬ë§
                if(Math.abs(p.x - camX) > viewW) continue;

                ctx.globalAlpha = p.life / 30;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
            }

            // ë¦¬í•„
            if(entities.filter(e=>e.type==='shape').length < 200) spawnShape();

            updateLeaderboard();
            animationFrameId = requestAnimationFrame(loop);
        }

        function updateTank(t) {
            if(t.hp <= 0) return;

            let moveX = 0, moveY = 0;
            
            if(t.isHuman) {
                // 1. í¬ì‹  ë°©í–¥ (ë§ˆìš°ìŠ¤/í„°ì¹˜)
                if(inputType === 'mouse') {
                    // ë§ˆìš°ìŠ¤ ì¢Œí‘œë¥¼ ê²Œì„ ì›”ë“œ ì¢Œí‘œë¡œ ë³€í™˜ í•„ìš”í•˜ì§€ë§Œ
                    // í”Œë ˆì´ì–´ê°€ í•­ìƒ ì¤‘ì•™ì— ìˆìœ¼ë¯€ë¡œ í™”ë©´ ì¤‘ì•™ ê¸°ì¤€ ê°ë„ ê³„ì‚°
                    t.gunAngle = Math.atan2(mouseY - canvas.height/2, mouseX - canvas.width/2);
                } else if(isFiring) {
                    t.gunAngle = Math.atan2(joystickVector.y, joystickVector.x);
                }

                // 2. ì´ë™ (WASD)
                if(keys['w'] || keys['W'] || keys['ArrowUp']) moveY = -1;
                if(keys['s'] || keys['S'] || keys['ArrowDown']) moveY = 1;
                if(keys['a'] || keys['A'] || keys['ArrowLeft']) moveX = -1;
                if(keys['d'] || keys['D'] || keys['ArrowRight']) moveX = 1;

                if(joystickActive) {
                    moveX = joystickVector.x;
                    moveY = joystickVector.y;
                }

                // 3. ë°œì‚¬
                if(isFiring && t.reload <= 0) {
                    spawnBullet(t);
                    t.reload = t.reloadTime;
                }

            } else {
                // ë´‡ AI
                t.aiTimer--;
                if(t.aiTimer <= 0) {
                    t.aiTimer = 10;
                    let closest = null;
                    let minDist = 700;
                    
                    entities.forEach(other => {
                        if(other.type === 'tank' && other !== t && other.hp > 0) {
                            let d = Math.hypot(t.x-other.x, t.y-other.y);
                            if(d < minDist) { minDist = d; closest = other; t.aiState = 'combat'; }
                        }
                    });

                    if(!closest) {
                        t.aiState = 'farm';
                        entities.forEach(s => {
                            if(s.type === 'shape') {
                                let d = Math.hypot(t.x-s.x, t.y-s.y);
                                if(d < minDist) { minDist = d; closest = s; }
                            }
                        });
                    }
                    t.aiTarget = closest;
                }

                if(t.aiTarget) {
                    // ë´‡ì€ ì´ë™ë°©í–¥ê³¼ ì´êµ¬ê°€ ê°™ìŒ (ë‹¨ìˆœí™”)
                    t.gunAngle = Math.atan2(t.aiTarget.y - t.y, t.aiTarget.x - t.x);
                    moveX = Math.cos(t.gunAngle);
                    moveY = Math.sin(t.gunAngle);
                    
                    let dist = Math.hypot(t.aiTarget.x - t.x, t.aiTarget.y - t.y);
                    if(dist > 200) { /* ì ‘ê·¼ */ }
                    else if(dist < 100) { moveX *= -1; moveY *= -1; } // í›„í‡´
                    else { moveX = 0; moveY = 0; } // ì •ì§€

                    if(dist < 450 && t.reload <= 0) {
                        spawnBullet(t);
                        t.reload = t.reloadTime;
                    }
                } else {
                    // ë°°íšŒ
                    t.gunAngle += 0.05;
                    moveX = Math.cos(t.gunAngle); moveY = Math.sin(t.gunAngle);
                }
            }

            // ì´ë™ ì •ê·œí™” ë° ì ìš©
            if(moveX !== 0 || moveY !== 0) {
                let len = Math.hypot(moveX, moveY);
                if(len > 1) len = 1;
                if(t.isHuman && !joystickActive && len > 0) { moveX /= len; moveY /= len; } // í‚¤ë³´ë“œëŠ” ì •ê·œí™”
                
                // ëª¸ì²´ íšŒì „ (ì´ë™ ë°©í–¥ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ)
                let targetBodyAngle = Math.atan2(moveY, moveX);
                let diff = targetBodyAngle - t.angle;
                while (diff <= -Math.PI) diff += Math.PI*2;
                while (diff > Math.PI) diff -= Math.PI*2;
                t.angle += diff * 0.2;

                t.x += moveX * t.speed;
                t.y += moveY * t.speed;
                t.x = Math.max(0, Math.min(MAP_SIZE, t.x));
                t.y = Math.max(0, Math.min(MAP_SIZE, t.y));
            }

            t.reload--;
        }

        function updateBullet(b, idx) {
            b.x += b.vx;
            b.y += b.vy;
            b.life--;
            
            if(b.life <= 0 || b.x<0 || b.x>MAP_SIZE || b.y<0 || b.y>MAP_SIZE) {
                entities.splice(idx, 1);
                return;
            }

            for(let i=entities.length-1; i>=0; i--) {
                let e = entities[i];
                if(e === b || e.id === b.ownerId) continue;
                if(e.type === 'bullet') continue;

                let dist = Math.hypot(b.x - e.x, b.y - e.y);
                if(dist < b.r + e.r) {
                    e.hp -= b.damage;
                    createParticles(e.x, e.y, e.color, 3);
                    entities.splice(idx, 1);

                    if(e.hp <= 0) {
                        let owner = entities.find(ent => ent.id === b.ownerId);
                        if(owner) {
                            owner.score += e.score || 100;
                            if(owner.score > owner.level * 100) {
                                owner.level++;
                                owner.damage += 2;
                                owner.maxHp += 10;
                                owner.hp = owner.maxHp;
                                owner.r += 1;
                            }
                        }

                        if(e.type === 'tank') {
                            killTank(e, owner ? owner.name : 'Unknown');
                        } else {
                            createParticles(e.x, e.y, e.color, 5);
                            entities.splice(i, 1);
                        }
                    }
                    return;
                }
            }
        }

        function updateShape(s) {
            s.angle += s.rotationSpeed;
        }

        function drawEntity(e) {
            ctx.save();
            ctx.translate(e.x, e.y);

            if(e.type === 'tank') {
                // 1. í¬ì‹  ê·¸ë¦¬ê¸° (Gun Angle ê¸°ì¤€)
                ctx.save();
                ctx.rotate(e.gunAngle);
                ctx.fillStyle = '#999';
                ctx.fillRect(0, -e.r/2, e.r*2.2, e.r); 
                ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
                ctx.strokeRect(0, -e.r/2, e.r*2.2, e.r);
                ctx.restore();

                // 2. ëª¸ì²´ ê·¸ë¦¬ê¸° (Body Angle ê¸°ì¤€)
                ctx.rotate(e.angle);
                ctx.beginPath();
                ctx.arc(0, 0, e.r, 0, Math.PI*2);
                ctx.fillStyle = e.color; ctx.fill(); ctx.stroke();
                
                // ì¥ì‹ (íƒ±í¬ ê¶¤ë„ ëŠë‚Œ)
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(-e.r, -e.r, e.r*2, 6);
                ctx.fillRect(-e.r, e.r-6, e.r*2, 6);

                // 3. ì •ë³´ì°½ (íšŒì „ ì·¨ì†Œí•˜ê³  ì •ë°©í–¥)
                ctx.rotate(-e.angle);
                ctx.fillStyle = 'black'; ctx.fillRect(-20, e.r + 10, 40, 6);
                ctx.fillStyle = '#00b894'; ctx.fillRect(-19, e.r + 11, 38 * (e.hp/e.maxHp), 4);
                
                ctx.fillStyle = '#333'; ctx.font = 'bold 12px Noto Sans KR';
                ctx.textAlign = 'center';
                ctx.fillText(`${e.name} [Lv.${e.level}]`, 0, -e.r - 10);

            } else if(e.type === 'bullet') {
                ctx.rotate(Math.atan2(e.vy, e.vx));
                ctx.beginPath(); ctx.arc(0, 0, e.r, 0, Math.PI*2);
                ctx.fillStyle = e.color; ctx.fill(); ctx.stroke();
            } else if(e.type === 'shape') {
                ctx.rotate(e.angle);
                ctx.fillStyle = e.color;
                ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
                
                let sides = e.shapeType === 0 ? 4 : (e.shapeType === 1 ? 3 : 5);
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    ctx.lineTo(e.r * Math.cos(i * 2 * Math.PI / sides), e.r * Math.sin(i * 2 * Math.PI / sides));
                }
                ctx.closePath(); ctx.fill(); ctx.stroke();
                
                if(e.hp < e.maxHp) {
                    ctx.rotate(-e.angle);
                    ctx.fillStyle = 'black'; ctx.fillRect(-10, 5, 20, 4);
                    ctx.fillStyle = '#00b894'; ctx.fillRect(-9, 6, 18 * (e.hp/e.maxHp), 2);
                }
            }
            ctx.restore();
        }

        function killTank(t, killerName) {
            createParticles(t.x, t.y, t.color, 15);
            
            if(t.isHuman) {
                gameOver(killerName);
                t.hp = 0;
            } else {
                let idx = entities.indexOf(t);
                if(idx > -1) entities.splice(idx, 1);
                showKillLog(`${killerName}ë‹˜ì´ ${t.name}ì„ ì²˜ì¹˜!`);
                setTimeout(() => { if(gameRunning) spawnTank(false); }, 3000);
            }
        }

        function showKillLog(msg) {
            killLog.innerText = msg; killLog.style.opacity = 1;
            setTimeout(() => { killLog.style.opacity = 0; }, 2000);
        }

        function updateLeaderboard() {
            let list = entities.filter(e => e.type === 'tank').sort((a,b) => b.score - a.score);
            let html = '';
            for(let i=0; i<Math.min(5, list.length); i++) {
                let t = list[i];
                let name = t.isHuman ? `<span style="color:#0984e3">${t.name}</span>` : t.name;
                html += `<li>${i+1}. ${name} <small>(${t.score})</small></li>`;
            }
            rankList.innerHTML = html;
        }

        function gameOver(killer) {
            gameRunning = false;
            cancelAnimationFrame(animationFrameId);
            ingameAd.style.display = 'none';
            ui.style.display = 'block';
            
            const btn = document.getElementById('start-btn');
            btn.innerText = "ë³µìˆ˜í•˜ëŸ¬ ê°€ê¸°! (ì¬ì‹œì‘)";
            ui.querySelector('h1').innerText = "ğŸ’€ ê²©íŒŒë¨";
            ui.querySelector('p').innerHTML = `
                <b>${killer}</b>ì—ê²Œ ë‹¹í–ˆìŠµë‹ˆë‹¤...<br>
                ìµœì¢… ì ìˆ˜: <span style="color:#0984e3; font-weight:bold;">${player.score}</span>
            `;
        }
    </script>
</body>
</html>

